pipeline:
    setup:
        image: docker
        commands:
            - docker build --rm -t remilia/bilibili-live-notifier:latest .
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock

    restore_cache:
        image: drillster/drone-volume-cache
        restore: true
        mount:
            - ./.cargo
        volumes:
            - /home/drone/cache:/cache

    build:
        image: remilia/bilibili-live-notifier:latest
        commands:
            - export CARGO_HOME=./.cargo
            - cargo build

    test:
        image: remilia/bilibili-live-notifier:latest
        secrets: [ codecov_token ]
        commands:
            - export CARGO_HOME=./.cargo
            - cargo tarpaulin --out Xml -v
            - bash -c "bash <(curl -s https://codecov.io/bash)"

    rebuild_cache:
        image: drillster/drone-volume-cache
        rebuild: true
        mount:
            - ./.cargo
        volumes:
            - /home/drone/cache:/cache


    notify:
        image: appleboy/drone-telegram
        when:
            status: [ success, failure ]
        format: markdown
        to: -155562062
        secrets: [ telegram_token ]
        message: |
            {{#success build.status}}
                *Success* [{{repo.owner}}/{{repo.name}} #{{build.number}}]({{build.link}})
            {{else}}
                *Failed* {{build.link}}
            {{/success}}
            *Branch*: {{commit.Branch}}
            *Author*: {{commit.Author}}
            *Message*: {{commit.Message}}
            *Elapsed*: {{buildtime build.started}}
